<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.11.2/css/ol.css" type="text/css">
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <style>
      .map {
        height: 100%;
        width: 100%;
      }
      body, html {
      	height: 100%;
      	padding: 0;
      }
      
      #center {  
	float:left;
	width:20%;
	margin-top:10px;
	height:90%;
      }
	
      .container {
	  margin-top:3px;   
	  height:100%;  
	  border:2px solid #dedede; 
	  width:600px;
       }
       #popup {
       	  padding-bottom: 45px;
       }
    </style>
    <script src="http://openlayers.org/en/v3.11.2/build/ol.js" type="text/javascript"></script>
    <script type="text/javascript">
    document.addEventListener("DOMContentLoaded", function() {
        var iconStyle = new ol.style.Style({
           image: new ol.style.Icon ({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                opacity: 0.65,
                src: 'http://iconshow.me/download.phpl?file=path/media/images/Mixed/small-n-flat-icon/png2/48/-map-marker.png' // create commons license
           })
        });
        
        var thresholdStyle = new ol.style.Style({
        	image: new ol.style.Circle({
                        radius: 3,
                        fill: new ol.style.Fill({
                            color: 'green'
                        })
                    })	
        });
        var normalStyle = new ol.style.Style({
        	image: new ol.style.Circle({
                        radius: 3,
                        fill: new ol.style.Fill({
                            color: 'red'
                        })
                    })	
        });

        var styleFunction = function (feature, resolution) {
	    if (feature.get('rel') >= 0.6) {
		return [thresholdStyle];
	    } else {
		return [normalStyle];
	    }
	};
        
        var vectorSource = new ol.source.Vector({
                        //create empty vector
                    });


          var iconFeature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.transform([13, 51], 'EPSG:4326','EPSG:3857')),
                        name: "adsf",
                        population: 4000,
                        rainfall: 500
                    });

        var pointVector = new ol.source.Vector({
			  url : 'file:///home/dhaeb/dvl/R/Country-lore-analysis-Germany/geojson2.json',
			  format: new ol.format.GeoJSON()
        });
                    
        vectorSource.addFeature(iconFeature);
      	var map = new ol.Map({
        target: 'map',
        renderer: 'canvas',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.MapQuest({layer : "osm"})
          }),
          new ol.layer.Vector({
          	source: pointVector,
          	style : styleFunction	
          })
        ],                               
        view: new ol.View({
          center: new ol.proj.transform([10.41,51.30], "EPSG:4326", "EPSG:3857"),
          zoom: 7
        })
       });
       	
       var element = document.getElementById('popup');

	var popup = new ol.Overlay({
	  element: element,
	  positioning: 'bottom-center',
	  stopEvent: false
	});
	map.addOverlay(popup);
	
	// display popup on click
	map.on('click', function(evt) {
	  var feature = map.forEachFeatureAtPixel(evt.pixel,
	      function(feature, layer) {
		return feature;
	      });
	  console.log(feature);
	  if (feature) {
	    $(element).popover('destroy');
	    var geometry = feature.getGeometry();
	    var coord = geometry.getCoordinates();
	    popup.setPosition(coord);
	    $(element).popover({
	      'placement': 'top',
	      'html': true,
	      'content': "<table><tr><td>Ort: </td><td>" + feature.get('Ort') + "</td></tr>" 
	      		+ "<tr><td>Bundesland: </td><td>" + feature.get('Bundesland') + "</td></tr>"
	      		+ "<tr><td>Anzahl Messjahre: </td><td>" + feature.get('cAll') + "</td></tr>"
	      		+ "<tr><td>Verhaeltnis: </td><td>" + feature.get('rel') + "</td></tr>"
	      		+ "<tr><td>Lage: </td><td>" + feature.get('Lage') + "</td></tr>"
	      + "</table>" 
	    });
	    $(element).popover('show');
	  } else {
	    $(element).popover('destroy');
	  }
	});
	
	// change mouse cursor when over marker
	/*map.on('pointermove', function(e) {
	  if (e.dragging) {
	    $(element).popover('destroy');
	    return;
	  }
	  var pixel = map.getEventPixel(e.originalEvent);
	  var hit = map.hasFeatureAtPixel(pixel);
	  $("#map").style.cursor = hit ? 'pointer' : '';
	});*/
      });
    </script>
    <title>OpenLayers 3 example</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="popup"></div>
  </body>
</html>
