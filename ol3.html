<!doctype html>
<html lang="en">
  <head>
    <link rel="stylesheet" href="http://openlayers.org/en/v3.11.2/css/ol.css" type="text/css">
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <style>
      .map {
        height: 100%;
        width: 100%;
      }
      body, html {
      	height: 100%;
      	padding: 0;
      }
      
      #center {  
	float:left;
	width:20%;
	margin-top:10px;
	height:90%;
      }
	
      .container {
	  margin-top:3px;   
	  height:100%;  
	  border:2px solid #dedede; 
	  width:600px;
       }
       #popup {
       	  padding-bottom: 15px;
       }
    </style>
    <script src="http://openlayers.org/en/v3.11.2/build/ol.js" type="text/javascript"></script>
    <script type="text/javascript">
    
    var pointVector;
    
    (function($){
    	$.event.special.destroyed = {
		remove: function(o) {
			if (o.handler) {
				o.handler()
			}
		}
	}
    })(jQuery)
    
    function HSVtoRGB(h, s, v) {
	    var r, g, b, i, f, p, q, t;
	    if (arguments.length === 1) {
		s = h.s, v = h.v, h = h.h;
	    }
	    i = Math.floor(h * 6);
	    f = h * 6 - i;
	    p = v * (1 - s);
	    q = v * (1 - f * s);
	    t = v * (1 - (1 - f) * s);
	    switch (i % 6) {
		case 0: r = v, g = t, b = p; break;
		case 1: r = q, g = v, b = p; break;
		case 2: r = p, g = v, b = t; break;
		case 3: r = p, g = q, b = v; break;
		case 4: r = t, g = p, b = v; break;
		case 5: r = v, g = p, b = q; break;
	    }
	    return [Math.round(r * 255), 
	    	    Math.round(g * 255), 
	    	    Math.round(b * 255)];
	 };
    
    document.addEventListener("DOMContentLoaded", function() {
        var iconStyle = new ol.style.Style({
           image: new ol.style.Icon ({
                anchor: [0.5, 46],
                anchorXUnits: 'fraction',
                anchorYUnits: 'pixels',
                opacity: 0.65,
                src: 'http://iconshow.me/download.phpl?file=path/media/images/Mixed/small-n-flat-icon/png2/48/-map-marker.png' // create commons license
           })
        });
        
        function createPointStyle(color, radius){
            return new ol.style.Style({
        	image: new ol.style.Circle({
                        radius: radius,
                        fill: new ol.style.Fill({
                            color: color
                        })
                })
            });
        };
        
        var styleFunction = function (feature, resolution) {
            var rad = feature.get("cAll") / 10.0 + 1.0;
            var percentTrueCl = feature.get('rel');
            var color = HSVtoRGB(percentTrueCl,1,1); // choose color from red to red (but 0 is not a data value, so it wont be confused)
	    color.push(1);
	    return [createPointStyle(color, rad)];
	};
	
	var normalStyle = new ol.style.Style({
        	image: new ol.style.Circle({
                        radius: 3,
                        fill: new ol.style.Fill({
                            color: 'red'
                        })
                    })	
        });
        
        var invisble = new ol.style.Style({
        	image: new ol.style.Circle({
                        radius: 0,
                        fill: new ol.style.Fill({
                            color: [0,0,0,0]
                        })
                    })	
        });
        
          var iconFeature = new ol.Feature({
                        geometry: new ol.geom.Point(ol.proj.transform([13, 51], 'EPSG:4326','EPSG:3857')),
                        name: "adsf",
                        population: 4000,
                        rainfall: 500
                    });

        pointVector = new ol.source.Vector({
			  url : 'file:///home/dhaeb/dvl/R/Country-lore-analysis-Germany/novfeb_geo.json',
			  format: new ol.format.GeoJSON()
        });
        
    	pointVector.on("addfeature", function(vectorevent){
		//console.log(vectorevent.feature);
		
		//vectorevent.Qh = false;
		
	});      
	
      	var map = new ol.Map({
        target: 'map',
        renderer: 'canvas',
        layers: [
          new ol.layer.Tile({
            source: new ol.source.MapQuest({layer : "osm"})
          }),
          new ol.layer.Vector({
          	name : "data",
          	source: pointVector,
          	style : styleFunction,	
          })
        ],                               
        view: new ol.View({
          center: new ol.proj.transform([10.41,51.30], "EPSG:4326", "EPSG:3857"),
          zoom: 7
        })
       });
       	
       var element = document.getElementById('popup');

       var popup = new ol.Overlay({
	   element: element,
	   positioning: 'bottom-center',
	   stopEvent: false
       });
       map.addOverlay(popup);
	
	function createPopover(feature){
	    var geometry = feature.getGeometry();
	    var coord = geometry.getCoordinates();
	    popup.setPosition(coord);
	    $(element).popover({
	      'placement': 'top',
	      'html': true,
	      'trigger' :'manual',
	      'content': function(){
	      		return "<table><tr><td>Ort: </td><td>" + feature.get('Ort') + "</td></tr>" 
	      		+ "<tr><td>Bundesland: </td><td>" + feature.get('Bundesland') + "</td></tr>"
	      		+ "<tr><td>Anzahl Messjahre: </td><td>" + feature.get('cAll') + "</td></tr>"
	      		+ "<tr><td>Verhaeltnis: </td><td>" + feature.get('rel') + "</td></tr>"
	      		+ "<tr><td>Lage: </td><td>" + feature.get('Lage') + "</td></tr>"
	      		+ "<tr><td>Hoehe: </td><td>" + feature.get('Hoehe') + "</td></tr>"
	      		+ "</table>";
	      } 
	    });
	    $(element).popover('show');
	};
	
	// display popup on click
	map.on('click', function(evt) {
	  var feature = map.forEachFeatureAtPixel(evt.pixel,
	      function(feature, layer) {
		return feature;
	      });
	  var popoverDiv = $(element);
	  console.log("hier");
	  if (feature) {
	  	console.log(feature.B.Ort);
	  	var popoverContent = $("[id^='popover']")[0];
	  	if(popoverDiv.popover().length == 1){
  		    popoverDiv.popover('destroy');
  		    window.setTimeout(function(){createPopover(feature);}, 350)
	  	} else {
	    	    createPopover(feature);
	    	}
	  } else {
	    popoverDiv.popover('destroy');
	  }
	});
	
	
	
	// change mouse cursor when over marker
	/*map.on('pointermove', function(e) {
	  if (e.dragging) {
	    $(element).popover('destroy');
	    return;
	  }
	  var pixel = map.getEventPixel(e.originalEvent);
	  var hit = map.hasFeatureAtPixel(pixel);
	  $("#map").style.cursor = hit ? 'pointer' : '';
	});*/
      });
      $
    </script>
    <title>OpenLayers 3 example</title>
  </head>
  <body>
    <div id="map" class="map"></div>
    <div id="popup"></div>
  </body>
</html>
